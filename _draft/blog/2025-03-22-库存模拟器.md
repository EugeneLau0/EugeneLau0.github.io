
---
title: 用模拟器思维来计算库存
categories:
  - Blog
tags:
  - SQL
  - 库存管理
---

库存作为供应链系统中最为核心、最必须的功能，每一个业务单据的操作都牵扯到库存计算，所以它的处理效率涉及到全部业务的响应时长，一个具备高效的库存计算系统是衡量一款优秀供应链产品的核心指标。

## 背景

在我们的库存处理中存在一个问题，用户的批量操作会造成慢请求。

之所以会存在这样的一个问题，是库存计算中台在更新库存时，是一张单一张单进行更新，每一张单的耗时不大，可架不住单量大，最终导致整个请求的响应时间被拉长。

那我们在批量时为什么不进行异步更新库存呢？或者是所有单据同时进行更新呢？第一个问题的原因是不同单据中存在相同的商品，异步更新会造成死锁、大量的上下文切换。第二个问题，这里涉及到业务上的关健要求：部分单据库存不足时，另外一部分库存足够的单据需要能够正常的更新成功，即部分成功部分失败。

## 现有逻辑

库存处理主要流程是，先进行数据模型转换，再增量写库，在写完库之后进行负库存判断，如果库存不够则进行库存回滚。

（流程图）

虽然这种方式可以…，可对于大批量单据下执行效率不佳，即使我们对大批量操作在用户侧增加了处理进度条，缓解了用户对响应时长的感知，但这长时间持有数据库锁，会间接影响到系统中其他用户的使用。

对现有流程的治理变成必要的。

## 库存模拟器

大家玩模拟汽车、模拟游戏，都涉及到一个模拟器，它的一个宗旨就是通过模拟方式来反映真实的逻辑。

对于库存模拟器而言，它是模拟了原来数据库库存更新、数据库负库存判断逻辑，无需进行真是的数据库执行即可完成。